name: Sync Strava Data

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch Strava data
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          # Get fresh access token
          TOKEN_RESPONSE=$(curl -s -X POST https://www.strava.com/oauth/token \
            -d client_id=$STRAVA_CLIENT_ID \
            -d client_secret=$STRAVA_CLIENT_SECRET \
            -d refresh_token=$STRAVA_REFRESH_TOKEN \
            -d grant_type=refresh_token)

          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
          NEW_REFRESH_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.refresh_token')

          # Fetch recent activities (last 50)
          curl -s "https://www.strava.com/api/v3/athlete/activities?per_page=50" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            | jq '[.[] | {
                name: .name,
                type: .type,
                distance: .distance,
                moving_time: .moving_time,
                start_date: .start_date_local,
                average_heartrate: .average_heartrate,
                max_heartrate: .max_heartrate,
                total_elevation_gain: .total_elevation_gain
              }]' > data/strava.json

          # Fetch athlete stats
          ATHLETE_ID=$(echo $TOKEN_RESPONSE | jq -r '.athlete.id // empty')
          if [ -n "$ATHLETE_ID" ]; then
            curl -s "https://www.strava.com/api/v3/athletes/$ATHLETE_ID/stats" \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              | jq '{
                  all_time: {
                    total_distance: .all_run_totals.distance + .all_ride_totals.distance + .all_swim_totals.distance,
                    total_time: .all_run_totals.moving_time + .all_ride_totals.moving_time + .all_swim_totals.moving_time,
                    total_count: .all_run_totals.count + .all_ride_totals.count + .all_swim_totals.count
                  },
                  ytd: {
                    total_distance: .ytd_run_totals.distance + .ytd_ride_totals.distance + .ytd_swim_totals.distance,
                    total_time: .ytd_run_totals.moving_time + .ytd_ride_totals.moving_time + .ytd_swim_totals.moving_time,
                    total_count: .ytd_run_totals.count + .ytd_ride_totals.count + .ytd_swim_totals.count
                  }
                }' > data/strava-stats.json
          fi

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Strava data" && git push)
